{
    "AWSTemplateFormatVersion":"2010-09-09",
    "Description":"API server",
    "Parameters":{
        "KeyP":{
            "Type":"AWS::EC2::KeyPair::KeyName",
            "Description":"Please select Key"
        },
        "InstanceType":{
            "Type":"String",
            "AllowedValues":["t2.micro","t2.small","t2.medium"],
            "Description":"Select the Instance Type"
        }
    },
    "Mappings":{
        "RegionMap":{
            "us-east-1":{
                "micro":"ami-026c8acd92718196b"
            },
            "us-west-2":{
                "micro":"ami-068670db424b01e9a"
            }
        }
    },
    "Resources":{
        "LabEC2":{
            "Type": "AWS::EC2::Instance",
            "DependsOn":"LabVpc",
            "Properties":{
                "ImageId":{
                    "Fn::FindInMap":[
                        "RegionMap",{"Ref":"AWS::Region"},"micro"
                    ]
                },
                "InstanceType":{"Ref":"InstanceType"},
                "KeyName":{
                    "Ref":"KeyP"
                },
                "Tags":[
                    {
                        "Key":"Name",
                        "Value":{"Fn::Join":[" ",["API Server"," for ",{"Ref":"AWS::Region"}," and for stack ",{"Ref":"AWS::StackName"}]]}
                    }
                ],
                "NetworkInterfaces":[
                    {
                        "AssociatePublicIpAddress": "true",
                        "DeviceIndex": "0",
                        "GroupSet": [{ "Ref" : "EC2SG" }],
                        "SubnetId": { "Ref" : "LabSubnetPublic" }
                    }
                ]
            }

        },
        "LabEC21":{
            "Type": "AWS::EC2::Instance",
            "DependsOn":"LabVpc",
            "Properties":{
                "ImageId":{
                    "Fn::FindInMap":[
                        "RegionMap",{"Ref":"AWS::Region"},"micro"
                    ]
                },
                "InstanceType":{"Ref":"InstanceType"},
                "KeyName":{
                    "Ref":"KeyP"
                },
                "Tags":[
                    {
                        "Key":"Name",
                        "Value":{"Fn::Join":[" ",["API Node"," for ",{"Ref":"AWS::Region"}," and for stack ",{"Ref":"AWS::StackName"}]]}
                    }
                ],
                "NetworkInterfaces":[
                    {
                        "AssociatePublicIpAddress": "true",
                        "DeviceIndex": "0",
                        "GroupSet": [{ "Ref" : "EC2SG" }],
                        "SubnetId": { "Ref" : "LabSubnetPublic" }
                    }
                ]
            }

        },
        "EC2SG":{
            "Type":"AWS::EC2::SecurityGroup",
            "DependsOn":"LabVpc",
            "Properties":{
                "GroupDescription":"Security Group for EC2",
                "VpcId":{
                    "Ref":"LabVpc"
                },
                "SecurityGroupIngress":[
                    {
                        "IpProtocol":"tcp",
                        "CidrIp":"0.0.0.0/0",
                        "ToPort":"80",
                        "FromPort":"80"
                    },
                    {
                        "IpProtocol":"tcp",
                        "CidrIp":"0.0.0.0/0",
                        "ToPort":"22",
                        "FromPort":"22"
                    },
                    {
                        "IpProtocol":"tcp",
                        "CidrIp":"0.0.0.0/0",
                        "ToPort":"80",
                        "FromPort":"80"
                    },
                    {
                        "IpProtocol":"tcp",
                        "CidrIp":"0.0.0.0/0",
                        "ToPort":"8080",
                        "FromPort":"8080"
                    },
                    {
                        "IpProtocol":"tcp",
                        "CidrIp":"0.0.0.0/0",
                        "ToPort":"61000",
                        "FromPort":"32768"
                    },
                    {
                        "IpProtocol":"tcp",
                        "CidrIp":"0.0.0.0/0",
                        "ToPort":"443",
                        "FromPort":"443"
                    },
                    {
                        "IpProtocol":"tcp",
                        "CidrIp":"0.0.0.0/0",
                        "ToPort":"5000",
                        "FromPort":"5000"
                    },
                    {
                        "IpProtocol":"tcp",
                        "CidrIp":"0.0.0.0/0",
                        "ToPort":"2377",
                        "FromPort":"2377"
                    },
                    {
                        "IpProtocol":"tcp",
                        "CidrIp":"0.0.0.0/0",
                        "ToPort":"5601",
                        "FromPort":"5601"
                    },
                    {
                        "IpProtocol":"tcp",
                        "CidrIp":"0.0.0.0/0",
                        "ToPort":"9200",
                        "FromPort":"9200"
                    },
                    {
                        "IpProtocol":"tcp",
                        "CidrIp":"0.0.0.0/0",
                        "ToPort":"9300",
                        "FromPort":"9300"
                    },
                    {
                        "IpProtocol":"tcp",
                        "CidrIp":"0.0.0.0/0",
                        "ToPort":"5044",
                        "FromPort":"5044"
                    }
                ],
                "SecurityGroupEgress":[
                    {
                        "CidrIp":"0.0.0.0/0",
                        "ToPort":"-1",
                        "IpProtocol":"-1"
                    }
                ]
            }
        },
        "LabIG":{
            "Type":"AWS::EC2::InternetGateway",
            "DependsOn":"LabVpc",
            "Properties":{
                "Tags":[
                    {
                        "Key":"Name",
                        "Value":"LabIg"
                    }
                ]
            }
        },
        "LabRtPub":{
            "Type":"AWS::EC2::RouteTable",
            "DependsOn":"LabVpc",
            "Properties":{
                "Tags":[
                    {
                        "Key":"Name",
                        "Value":"Lab Public RT"
                    }
                ],
                "VpcId":{"Ref":"LabVpc"}
            }

        },
        "labigattach":{
            "Type":"AWS::EC2::VPCGatewayAttachment",
            "DependsOn":["LabVpc","LabIG"],
            "Properties":{
                "InternetGatewayId" : {"Ref":"LabIG"},
                "VpcId" : {"Ref":"LabVpc"}
            }
        },
        "labroute":{
            "Type":"AWS::EC2::Route",
            "DependsOn":["LabIG","LabRtPub"],
            "Properties":{
                "RouteTableId":{"Ref":"LabRtPub"},
                "DestinationCidrBlock":"0.0.0.0/0",
                "GatewayId":{"Ref":"LabIG"}
            }
        },
        "LabVpc":{
            "Type":"AWS::EC2::VPC",
            "Properties":{
                "CidrBlock":"10.0.0.0/16",
                "EnableDnsHostnames":"true",
                "InstanceTenancy":"default",
                "Tags":[
                    {
                        "Key":"Name",
                        "Value":"Lab VPC 1"
                    }
                ]
            }

        },
        "LabSubnetPublic":{
            "Type":"AWS::EC2::Subnet",
            "DependsOn":"LabVpc",
            "Properties":{
                "AvailabilityZone":"us-east-1a",
                "CidrBlock":"10.0.0.0/24",
                "VpcId":{"Ref":"LabVpc"},
                "Tags":[
                    {
                        "Key":"Name",
                        "Value":"LabSubnetPub1"
                    }
                ]
            }
        },
        "LabPublicNACL":{
            "Type":"AWS::EC2::NetworkAcl",
            "DependsOn":["LabVpc","LabSubnetPublic"],
            "Properties":{
                "Tags":[
                    {
                        "Key":"Name",
                        "Value":"LabPublicNACL"
                    }
                ],
                "VpcId":{"Ref":"LabVpc"}
            }
        },
        "LabSubnetNaclAssoc":{
            "Type":"AWS::EC2::SubnetNetworkAclAssociation",
            "DependsOn":["LabPublicNACL","LabSubnetPublic"],
            "Properties":{
                "NetworkAclId" : {"Ref":"LabPublicNACL"},
                "SubnetId" : {"Ref":"LabSubnetPublic"}
            }
        },
        "PublicNACL1Entry":{
            "Type":"AWS::EC2::NetworkAclEntry",
            "DependsOn":"LabPublicNACL",
            "Properties":{
                "RuleNumber":"10",
                "CidrBlock":"0.0.0.0/0",
                "Egress":false,
                "NetworkAclId":{"Ref":"LabPublicNACL"},
                "PortRange":{"From":"22","To":"22"},
                "Protocol":"6",
                "RuleAction":"allow"
            }
        },
        "PublicNACL1Entry1":{
            "Type":"AWS::EC2::NetworkAclEntry",
            "DependsOn":"LabPublicNACL",
            "Properties":{
                "RuleNumber":"10",
                "CidrBlock":"0.0.0.0/0",
                "Egress":true,
                "NetworkAclId":{"Ref":"LabPublicNACL"},
                "Protocol":"-1",
                "RuleAction":"allow"
            }
        },
        "PublicNACL1Entry2":{
            "Type":"AWS::EC2::NetworkAclEntry",
            "DependsOn":"LabPublicNACL",
            "Properties":{
                "RuleNumber":"20",
                "CidrBlock":"0.0.0.0/0",
                "Egress":false,
                "PortRange":{"From":"32768","To":"61000"},
                "NetworkAclId":{"Ref":"LabPublicNACL"},
                "Protocol":"6",
                "RuleAction":"allow"
            }
        },
        "PublicNACL1Entry3":{
            "Type":"AWS::EC2::NetworkAclEntry",
            "DependsOn":"LabPublicNACL",
            "Properties":{
                "RuleNumber":"30",
                "CidrBlock":"0.0.0.0/0",
                "Egress":false,
                "PortRange":{"From":"80","To":"80"},
                "NetworkAclId":{"Ref":"LabPublicNACL"},
                "Protocol":"6",
                "RuleAction":"allow"
            }
        },
        "PublicNACL1Entry4":{
            "Type":"AWS::EC2::NetworkAclEntry",
            "DependsOn":"LabPublicNACL",
            "Properties":{
                "RuleNumber":"40",
                "CidrBlock":"0.0.0.0/0",
                "Egress":false,
                "PortRange":{"From":"8080","To":"8080"},
                "NetworkAclId":{"Ref":"LabPublicNACL"},
                "Protocol":"6",
                "RuleAction":"allow"
            }
        },
        "PublicNACL1Entry5":{
            "Type":"AWS::EC2::NetworkAclEntry",
            "DependsOn":"LabPublicNACL",
            "Properties":{
                "RuleNumber":"50",
                "CidrBlock":"0.0.0.0/0",
                "Egress":false,
                "PortRange":{"From":"443","To":"443"},
                "NetworkAclId":{"Ref":"LabPublicNACL"},
                "Protocol":"6",
                "RuleAction":"allow"
            }
        },
        "PublicNACL1Entry6":{
            "Type":"AWS::EC2::NetworkAclEntry",
            "DependsOn":"LabPublicNACL",
            "Properties":{
                "RuleNumber":"60",
                "CidrBlock":"0.0.0.0/0",
                "Egress":false,
                "PortRange":{"From":"5000","To":"5000"},
                "NetworkAclId":{"Ref":"LabPublicNACL"},
                "Protocol":"6",
                "RuleAction":"allow"
            }
        },
        "PublicNACL1Entry7":{
            "Type":"AWS::EC2::NetworkAclEntry",
            "DependsOn":"LabPublicNACL",
            "Properties":{
                "RuleNumber":"70",
                "CidrBlock":"0.0.0.0/0",
                "Egress":false,
                "PortRange":{"From":"2377","To":"2377"},
                "NetworkAclId":{"Ref":"LabPublicNACL"},
                "Protocol":"6",
                "RuleAction":"allow"
            }
        },
        "PublicNACL1Entry8":{
            "Type":"AWS::EC2::NetworkAclEntry",
            "DependsOn":"LabPublicNACL",
            "Properties":{
                "RuleNumber":"80",
                "CidrBlock":"0.0.0.0/0",
                "Egress":false,
                "PortRange":{"From":"5601","To":"5601"},
                "NetworkAclId":{"Ref":"LabPublicNACL"},
                "Protocol":"6",
                "RuleAction":"allow"
            }
        },
        "PublicNACL1Entry9":{
            "Type":"AWS::EC2::NetworkAclEntry",
            "DependsOn":"LabPublicNACL",
            "Properties":{
                "RuleNumber":"90",
                "CidrBlock":"0.0.0.0/0",
                "Egress":false,
                "PortRange":{"From":"9200","To":"9200"},
                "NetworkAclId":{"Ref":"LabPublicNACL"},
                "Protocol":"6",
                "RuleAction":"allow"
            }
        },
        "PublicNACL1Entry10":{
            "Type":"AWS::EC2::NetworkAclEntry",
            "DependsOn":"LabPublicNACL",
            "Properties":{
                "RuleNumber":"100",
                "CidrBlock":"0.0.0.0/0",
                "Egress":false,
                "PortRange":{"From":"9300","To":"9300"},
                "NetworkAclId":{"Ref":"LabPublicNACL"},
                "Protocol":"6",
                "RuleAction":"allow"
            }
        },
        "PublicNACL1Entry11":{
            "Type":"AWS::EC2::NetworkAclEntry",
            "DependsOn":"LabPublicNACL",
            "Properties":{
                "RuleNumber":"110",
                "CidrBlock":"0.0.0.0/0",
                "Egress":false,
                "PortRange":{"From":"5044","To":"5044"},
                "NetworkAclId":{"Ref":"LabPublicNACL"},
                "Protocol":"6",
                "RuleAction":"allow"
            }
        },
        "PublicNACLRtAssoc":{
            "Type":"AWS::EC2::SubnetRouteTableAssociation",
            "DependsOn":["LabSubnetPublic","LabRtPub"],
            "Properties":{
                "RouteTableId" : {"Ref":"LabRtPub"},
                "SubnetId" : {"Ref":"LabSubnetPublic"}
            }
        }
    },
    "Outputs":{
        "InstanceId":{
            "Description":"The instance",
            "Value":{
                "Ref":"LabEC2"
            }
        },
        "Instanceip":{
            "Description":"Public IP",
            "Value":{
                "Fn::GetAtt":["LabEC2","PublicIp"]
            }
        }
    }
}